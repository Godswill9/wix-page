<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Booking Services</title>
</head>
<body>

  <!-- HEADER -->
  <header style="background-color:#1e3a8a; padding: 1rem; color: white;">
    <div style="max-width: 1000px; margin: auto; display: flex; justify-content: space-between; align-items: center;">
      <h2 style="margin: 0;">My Services</h2>
      <nav>
        <a href="#bookings-tab" style="color:white; text-decoration:none; margin-right:1rem;">Bookings</a>
        <a href="#form-tab" style="color:white; text-decoration:none;">Request Form</a>
      </nav>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main>
    <div class="container">
      <!-- Bookings Tab -->
      <div id="bookings-tab" class="tab active">
        <div class="booking-list" id="booking-list">
          <!-- Booking Cards -->
          <div class="booking-card" data-service="shipping">
            <img src="https://static.wixstatic.com/media/84770f_6d0063aa74714a2e8e524786f81252d9~mv2.jpg" alt="Service Image">
            <h3>UK to Nigeria Shipping</h3>
            <p>Reliable and affordable shipping services from the UK to Nigeria.</p>
            <div class="price">$39</div>
            <div class="btn" onclick="openFormTab('shipping')">Request Shipping</div>
          </div>

          <div class="booking-card" data-service="purchase">
            <img src="https://static.wixstatic.com/media/84770f_6d0063aa74714a2e8e524786f81252d9~mv2.jpg" alt="Service Image">
            <h3>Help Me Buy</h3>
            <p>Let us assist you in purchasing hard-to-find products.</p>
            <div class="price">$50</div>
            <div class="btn" onclick="openFormTab('purchase')">Request Purchase Help</div>
          </div>
        </div>
        <div id="carousel-indicators" class="carousel-indicators"></div>
      </div>

      <!-- Form Tab -->
      <div id="form-tab" class="tab">
        <div class="btn" onclick="goBack()">← Back to Bookings</div>
        <div id="form-container"></div>
      </div>
    </div>

    <!-- Popup Modal -->
    <!-- <div id="custom-modal" class="modal hidden">
      <div class="modal-content">
        <p id="modal-message"></p>
        <div id="modal-options" class="options"></div>
    <button 
  onclick="closeModal()" 
  style="background-color: #ef4444; color: white; border: none; padding: 0.5rem 1.25rem; font-size: 0.65rem; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.15); transition: background-color 0.2s ease;"
  onmouseover="this.style.backgroundColor='#dc2626'"
  onmouseout="this.style.backgroundColor='#ef4444'"
  onmousedown="this.style.backgroundColor='#b91c1c'"
  onmouseup="this.style.backgroundColor='#dc2626'"
>
  Close
</button>

      </div>
    </div> -->
  </main>

 
<style>
  * { box-sizing: border-box; }

  body, html {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
  }

  .container {
    max-width: 1000px;
    margin: auto;
    padding: 20px;
  }

  .tab { display: none; }
  .tab.active { display: block; }

  .booking-list {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
     height: 30em;
    justify-content: center;
  }

  .booking-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 100%;
    max-width: 300px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    flex-shrink: 0;
    margin-right:5em
  }

  .booking-card img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
  }

  .price {
    font-size: 16px;
    font-weight: bold;
    color: #222;
    margin-bottom: 10px;
  }

  .btn {
    background-color: #1e3a8a;
    color: white;
    padding: 10px 15px;
    text-align: center;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 10px;
    display: inline-block;
  }

  .input {
    padding: 10px;
    width: 100%;
    margin-bottom: 15px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  .service-form {
    background: #f8f8f8;
    padding: 15px;
    border-radius: 8px;
    margin-top: 20px;
  }
  
    .modal {
    position: fixed;
    z-index: 9999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex; align-items: center; justify-content: center;
  }
  .modal-button {
  background-color: #1e3a8a;
  color: white;
  padding: 0.5rem 1rem;
  margin: 5px;
  border: none;
  cursor: pointer;
  border-radius: 5px;
}

  .modal.hidden { display: none; }
  .modal-content {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
    max-width: 400px;
    width: 90%;
  }
  .options button {
    margin: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    background-color: #1e3a8a;
    color: white;
    cursor: pointer;
  }
  .modal-content .close-btn {
    margin-top: 1rem;
    background-color: #ccc;
    color: #000;
  }

  @media screen and (max-width: 600px) {
    .booking-list {
      flex-wrap: nowrap;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      gap: 10px;
      justify-content: flex-start;
    }

    .booking-card {
      scroll-snap-align: start;
      min-width: 80%;
      margin-right: 10px;
    }

    .booking-list::-webkit-scrollbar { display: none; }
    .booking-list { scrollbar-width: none; }

    .carousel-indicators {
      text-align: center;
      margin-top: 10px;
    }

    .carousel-indicators .dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      background-color: #ccc;
      border-radius: 50%;
      margin: 0 5px;
      cursor: pointer;
    }

    .carousel-indicators .dot.active {
      background-color: #1e3a8a;
    }
  }
</style>

<script>
  // Tab Navigation
  function goBack() {
    document.getElementById('form-tab')?.classList.remove('active');
    document.getElementById('bookings-tab')?.classList.add('active');
  }

  function openFormTab(type) {
    const container = document.getElementById('form-container');
    if (!container) return;

    const isShipping = type === 'shipping';
    const formHTML = `
      <div class="service-form">
        <h4>${isShipping ? 'UK to Nigeria Shipping Form' : 'Help Me Buy Form'}</h4>
        <input type="text" id="fullName" class="input" placeholder="Your full name"><br>
        <input type="email" id="email" class="input" placeholder="Your email"><br>
        ${isShipping ? `
          <textarea id="message" class="input" rows="2" placeholder="Full delivery address in Nigeria"></textarea><br>
        ` : `
          <input type="text" id="productLink" class="input" placeholder="Product link (URL)"><br>
          <input type="text" id="size" class="input" placeholder="Size / Variant (optional)"><br>
          <input type="number" id="quantity" class="input" min="1" value="1"><br>
          <textarea id="additionalNotes" class="input" rows="3" placeholder="Additional notes or instructions"></textarea><br>
        `}
        <input type="date" id="requestedDate" class="input"><br>
        <input type="file" id="attachedFile"><br><br>
        <input type="hidden" id="type" value="${isShipping ? 'Shipping' : 'Purchase'}">
        <div class="btn" onclick="${isShipping ? 'onShippingRequestClick()' : 'onPurchaseRequestClick()'}">Submit ${isShipping ? 'Shipping' : 'Purchase'} Request</div>
      </div>
    `;

    container.innerHTML = formHTML;
    document.getElementById('bookings-tab')?.classList.remove('active');
    document.getElementById('form-tab')?.classList.add('active');
  }

 // Show a generic modal with message and custom option buttons
function showModal({ message, options = [] }) {
  // Remove existing modal if any
  const old = document.getElementById('custom-modal');
  if (old) old.remove();

  // Create overlay
  const modal = document.createElement('div');
  modal.id = 'custom-modal';
  Object.assign(modal.style, {
    position: 'fixed',
    top: 0, left: 0, width: '100vw', height: '100vh',
    backgroundColor: 'rgba(0,0,0,0.5)',
    display: 'flex',
    justifyContent: 'center',
    alignItems: 'center',
    zIndex: 9999,
  });

  // Create content box
  const content = document.createElement('div');
  Object.assign(content.style, {
    backgroundColor: '#fff',
    padding: '1.5rem',
    borderRadius: '8px',
    maxWidth: '400px',
    width: '90%',
    boxShadow: '0 5px 15px rgba(0,0,0,0.3)',
    textAlign: 'center',
  });

  // Message paragraph
  const p = document.createElement('p');
  p.textContent = message;
  p.style.marginBottom = '1rem';
  p.style.fontSize = '1.1rem';

  // Buttons container
  const buttonsDiv = document.createElement('div');
  buttonsDiv.style.display = 'flex';
  buttonsDiv.style.justifyContent = 'center';
  buttonsDiv.style.gap = '0.5rem';
  buttonsDiv.style.flexWrap = 'wrap';

  // Create buttons from options
  if (options.length === 0) {
    const btn = createModalButton('Close', () => closeModal(modal));
    buttonsDiv.appendChild(btn);
  } else {
    options.forEach(({ label, onClick }) => {
      const btn = createModalButton(label, () => {
        onClick();
        closeModal(modal);
      });
      buttonsDiv.appendChild(btn);
    });
  }

  content.appendChild(p);
  content.appendChild(buttonsDiv);
  modal.appendChild(content);
  document.body.appendChild(modal);
}

// Show a simple error modal with only message and a Close button
function showStatusModal(message, type = 'success') {
  // Remove existing modal if present
  const existing = document.getElementById('status-modal');
  if (existing) existing.remove();

  // Create overlay
  const modal = document.createElement('div');
  modal.id = 'status-modal';
  Object.assign(modal.style, {
    position: 'fixed',
    top: 0, left: 0, width: '100vw', height: '100vh',
    backgroundColor: 'rgba(0, 0, 0, 0.4)',
    display: 'flex',
    justifyContent: 'center',
    alignItems: 'center',
    zIndex: 10000,
  });

  // Create modal content box
  const content = document.createElement('div');
  Object.assign(content.style, {
    backgroundColor: '#fff',
    padding: '1.5rem 2rem',
    borderRadius: '10px',
    minWidth: '300px',
    maxWidth: '90%',
    boxShadow: '0 2px 10px rgba(0,0,0,0.2)',
    textAlign: 'center',
    fontFamily: 'Arial, sans-serif',
  });

  // Color based on type
  if (type === 'success') {
    content.style.border = '4px solid #22c55e'; // green border
  } else if (type === 'error') {
    content.style.border = '4px solid #ef4444'; // red border
  } else {
    content.style.border = '4px solid #3b82f6'; // blue for info/default
  }

  // Message text
  const msg = document.createElement('p');
  msg.textContent = message;
  msg.style.margin = '0 0 1rem 0';
  msg.style.fontSize = '1.1rem';
  msg.style.color = '#111';

  // Close button
  const btn = document.createElement('button');
  btn.textContent = 'Close';
  Object.assign(btn.style, {
    padding: '0.5rem 1.2rem',
    fontSize: '1rem',
    borderRadius: '6px',
    border: 'none',
    cursor: 'pointer',
    backgroundColor: type === 'success' ? '#22c55e' : '#ef4444',
    color: 'white',
    boxShadow: '0 2px 6px rgba(0,0,0,0.15)',
    transition: 'background-color 0.2s ease',
  });

  // Hover effect for button
  btn.onmouseover = () => {
    btn.style.backgroundColor = type === 'success' ? '#16a34a' : '#dc2626';
  };
  btn.onmouseout = () => {
    btn.style.backgroundColor = type === 'success' ? '#22c55e' : '#ef4444';
  };
  btn.onclick = () => {
    modal.remove();
  };

  // Append children
  content.appendChild(msg);
  content.appendChild(btn);
  modal.appendChild(content);
  document.body.appendChild(modal);
}

// Helper to create styled modal buttons
function createModalButton(label, onClick) {
  const btn = document.createElement('button');
  btn.textContent = label;
  Object.assign(btn.style, {
    padding: '0.5rem 1rem',
    border: 'none',
    borderRadius: '6px',
    backgroundColor: '#3b82f6',
    color: 'white',
    cursor: 'pointer',
    fontSize: '0.9rem',
    transition: 'background-color 0.2s ease',
  });
  btn.onclick = onClick;
  btn.onmouseover = () => (btn.style.backgroundColor = '#2563eb');
  btn.onmouseout = () => (btn.style.backgroundColor = '#3b82f6');
  return btn;
}

// Close and remove the given modal element
function closeModal(modal) {
  if (modal && modal.parentNode) {
    modal.parentNode.removeChild(modal);
  }
}


  // Request Confirmation
  function onShippingRequestClick() {
    showModal({
      message: "From where are you requesting shipping?",
      options: [
        { label: "Nigeria / Africa", onClick: () =>submitForm("Nigeria") },
        { label: "Outside Africa", onClick: () => submitForm("outside") }
      ]
    });
  }

  function onPurchaseRequestClick() {
    showModal({
      message: "From where are you requesting purchase?",
      options: [
        { label: "Nigeria / Africa", onClick: () => submitForm("Nigeria") },
        { label: "Outside Africa", onClick: () => submitForm("outside") }
      ]
    });
  }

async function submitForm(zone) {
  const fullName = document.getElementById('fullName')?.value.trim();
  const email = document.getElementById('email')?.value.trim();
  const type = document.getElementById('type')?.value;
  const message = document.getElementById('message')?.value?.trim();
  const productLink = document.getElementById('productLink')?.value?.trim();
  const size = document.getElementById('size')?.value?.trim();
  const quantity = parseInt(document.getElementById('quantity')?.value) || 1;
  const notes = document.getElementById('additionalNotes')?.value?.trim();
  const requestedDate = document.getElementById('requestedDate')?.value;
  const attachedFile = document.getElementById('attachedFile')?.files[0]; // optional

  if (!fullName || !email || !type) {
    showStatusModal("Please fill in all required fields.", "error");
    return;
  }

  // Save everything to localStorage for reuse after payment
  const userDetails = {
    fullName, email, type, message, productLink, size,
    quantity, notes, requestedDate, zone
  };
  localStorage.setItem('userDetails', JSON.stringify(userDetails));

  if (attachedFile) {
    // Since localStorage can’t store files, store file name only for UI reference
    localStorage.setItem('attachedFileName', attachedFile.name);
    localStorage.setItem('attachedFileContent', await toBase64(attachedFile)); // optionally encode file to base64
  }

  try {
    if (zone === 'Nigeria') {
      const amount = calculateAmount(quantity, type); // You define logic
      const res = await fetch('http://localhost:8092/api/payments/paystack', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, amount })
      });

      const data = await res.json();

      if (res.ok && data?.data?.authorization_url) {
        // Redirect to Paystack checkout
        window.location.href = data.data.authorization_url;
      } else {
        showStatusModal(data.message || "Payment initiation failed", "error");
      }
    } else {
      const sess_tok = generateSessionToken();
      const res = await fetch('http://localhost:8092/api/paymets/gocardless', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: fullName, email, sess_tok })
      });

      const data = await res.json();

      if (res.ok) {
        // Immediately proceed to form submission after payment for outside zone
        await finalizeFormSubmission(attachedFile);
      } else {
        showStatusModal(data.message || "Payment failed", "error");
      }
    }

  } catch (error) {
    console.error('Payment or submission error:', error);
    showStatusModal("Something went wrong. Please try again.", "error");
  }
}

// Optional helper: Convert file to base64
function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
  });
}

// Dummy example for calculating amount
function calculateAmount(quantity, type) {
  const baseRate = 1000;
  return quantity * baseRate;
}

// Dummy token generator
function generateSessionToken() {
  return Math.random().toString(36).substring(2, 12);
}

// Finalize form (for non-paystack flows or after Paystack redirects)
async function finalizeFormSubmission(fileBlob = null) {
  const userDetails = JSON.parse(localStorage.getItem('userDetails') || '{}');
  const base64File = localStorage.getItem('attachedFileContent');

  const formData = new FormData();
  Object.entries(userDetails).forEach(([key, val]) => formData.append(key, val));

  if (base64File) {
    const blob = base64ToBlob(base64File);
    formData.append('attachedFile', blob, localStorage.getItem('attachedFileName'));
  }

  try {
    const res = await fetch('http://localhost:8092/api/bookings/submitForm', {
      method: 'POST',
      body: formData,
    });

    const data = await res.json();

    if (res.ok) {
      showStatusModal(data.message || "Request submitted!");
      localStorage.clear(); // Clear saved form data
      goBack();
    } else {
      showStatusModal(data.error || "Submission failed", "error");
    }
  } catch (error) {
    console.error('Final submission error:', error);
    showStatusModal("Failed to submit form after payment", "error");
  }
}

function base64ToBlob(base64) {
  const parts = base64.split(';base64,');
  const mime = parts[0].split(':')[1];
  const bytes = atob(parts[1]);
  let length = bytes.length;
  const out = new Uint8Array(length);
  while (length--) out[length] = bytes.charCodeAt(length);
  return new Blob([out], { type: mime });
}


// Helper to generate random session token
function generateSessionToken() {
  return Math.random().toString(36).substring(2, 15);
}

// Dummy example for amount calculation
function calculateAmount(quantity, type) {
  const basePrice = 1000; // example price per unit
  return quantity * basePrice;
}


  // Carousel (Booking Cards)
  function setupCarouselIndicators() {
    const bookingList = document.getElementById('booking-list');
    const indicators = document.getElementById('carousel-indicators');
    const cards = bookingList?.querySelectorAll('.booking-card') || [];

    if (!indicators) return;
    indicators.innerHTML = '';

    cards.forEach((_, i) => {
      const dot = document.createElement('span');
      dot.className = 'dot' + (i === 0 ? ' active' : '');
      dot.onclick = () => bookingList.scrollTo({ left: cards[i].offsetLeft, behavior: 'smooth' });
      indicators.appendChild(dot);
    });

    bookingList?.addEventListener('scroll', () => {
      const scrollLeft = bookingList.scrollLeft;
      const cardWidth = cards[0]?.offsetWidth || 0;
      const index = Math.round(scrollLeft / (cardWidth + 10));
      indicators.querySelectorAll('.dot').forEach((d, i) =>
        d.classList.toggle('active', i === index)
      );
    });
  }

  window.addEventListener('load', setupCarouselIndicators);
  window.addEventListener('resize', setupCarouselIndicators);
</script>



</body>
</html>
